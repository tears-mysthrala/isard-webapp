import os
import json
import requests
import base64
from urllib.parse import unquote
from flask import Flask, render_template_string, redirect, url_for, flash, request, jsonify, Response, session
from functools import wraps

# --- CONFIGURATION ---
API_BASE_URL = "https://cloud.uni.eus/api/v3"
CONFIG_FILE = "config.json"

MAQUINAS = {}  # Cache for VMs

# --- FOLDERS ---
FOLDERS_FILE = "folders.json"
FOLDERS = {}  # { "folder_id": { "name": "Folder Name", "machines": ["vm_id1", "vm_id2"] } }

# --- API KEY CONFIGURATION ---
def load_config():
    """Loads configuration (last API key used)."""
    try:
        if os.path.exists(CONFIG_FILE):
            with open(CONFIG_FILE, "r") as f:
                return json.load(f)
    except Exception as e:
        print(f"Error al cargar config: {e}")
    return {}

def save_config(config):
    """Saves configuration."""
    try:
        with open(CONFIG_FILE, "w") as f:
            json.dump(config, f)
    except Exception as e:
        print(f"Error al guardar config: {e}")

def get_api_headers():
    """Gets API headers using the session API Key."""
    api_key = session.get('api_key')
    if not api_key:
        return None
    return {"Authorization": f"Bearer {api_key}", "Content-Type": "application/json"}

def handle_api_error(response):
    """Handles API errors, especially invalid authentication."""
    if response.status_code == 401:
        # Invalid or expired API Key
        session.pop('api_key', None)
        session['api_error'] = 'invalid_key'
        return True
    return False

def require_api_key(f):
    """Decorator to require API Key in session."""
    @wraps(f)
    def decorated_function(*args, **kwargs):
        if 'api_key' not in session:
            return redirect(url_for('login'))
        return f(*args, **kwargs)
    return decorated_function


def load_folders():
    """Carga las carpetas desde el archivo JSON."""
    global FOLDERS
    try:
        if os.path.exists(FOLDERS_FILE):
            with open(FOLDERS_FILE, "r") as f:
                FOLDERS = json.load(f)
    except Exception as e:
        print(f"Error al cargar carpetas: {e}")
        FOLDERS = {}


def save_folders():
    """Guarda las carpetas en el archivo JSON."""
    try:
        with open(FOLDERS_FILE, "w") as f:
            json.dump(FOLDERS, f, indent=2)
    except Exception as e:
        print(f"Error al guardar carpetas: {e}")


def get_next_folder_id():
    """Obtiene el siguiente ID disponible para una carpeta."""
    if not FOLDERS:
        return "1"
    return str(max(int(k) for k in FOLDERS.keys()) + 1)


def get_folder_for_machine(vm_id):
    """Obtiene la carpeta a la que pertenece una m치quina."""
    for folder_id, folder in FOLDERS.items():
        if vm_id in folder.get("machines", []):
            return folder_id
    return None


def get_machines_without_folder():
    """Obtiene las m치quinas que no est치n en ninguna carpeta."""
    assigned_machines = set()
    for folder in FOLDERS.values():
        assigned_machines.update(folder.get("machines", []))
    return {vm_id: vm for vm_id, vm in MAQUINAS.items() if vm_id not in assigned_machines}


def get_machines_in_folder(folder_id):
    """Obtiene las m치quinas que est치n en una carpeta espec칤fica."""
    if folder_id not in FOLDERS:
        return {}
    machine_ids = FOLDERS[folder_id].get("machines", [])
    return {vm_id: vm for vm_id, vm in MAQUINAS.items() if vm_id in machine_ids}


# Load folders on startup
load_folders()

# --- FLASK APPLICATION ---

app = Flask(__name__)
app.secret_key = "super_secreto_isard"  # Key for flash messages

# ==============================================================================
# FUNCIONES DE API
# ==============================================================================


def fetch_vms():
    """Obtiene la lista de escritorios del usuario."""
    global MAQUINAS
    url = f"{API_BASE_URL}/user/desktops"
    headers = get_api_headers()
    if not headers:
        return False
    try:
        response = requests.get(url, headers=headers)
        if handle_api_error(response):
            return False
        response.raise_for_status()
        data = response.json()
        MAQUINAS = {}
        for vm in data:
            # Extract IP addresses from interfaces
            ips = []
            interfaces = vm.get("interfaces", []) or vm.get("guest_properties", {}).get("ips", [])
            if isinstance(interfaces, list):
                for iface in interfaces:
                    if isinstance(iface, dict):
                        ip = iface.get("ip") or iface.get("ip-address")
                        if ip:
                            ips.append(ip)
                    elif isinstance(iface, str):
                        ips.append(iface)
            
            # Also check for ip field directly
            if not ips and vm.get("ip"):
                ips = [vm.get("ip")] if isinstance(vm.get("ip"), str) else vm.get("ip", [])
            
            # Extract viewer/SPICE connection info
            viewer = vm.get("viewer", {}) or {}
            spice_url = viewer.get("spice") or viewer.get("spice-client") or ""
            
            # Also check for direct spice field
            if not spice_url:
                spice_url = vm.get("spice") or vm.get("spice_url") or ""
            
            MAQUINAS[str(vm["id"])] = {
                "id": vm["id"],
                "name": vm.get("name", f"M치quina {vm['id']}"),
                "status": vm.get("state", "Desconocido"),
                "ips": ips,
                "spice": spice_url,
                "viewer": viewer,
            }
        return True
    except Exception as e:
        print(f"Error al obtener VMs: {e}")
        return False


def get_viewer_url(vm_id, viewer_type="browser-vnc"):
    """
    Obtiene la URL del visor para conectar a una VM.
    viewer_type puede ser: browser-vnc, browser-rdp, browser-spice, file-spice, file-rdpgw, file-rdpvpn
    
    Based on IsardVDI API:
    - browser-vnc: Returns urlp with noVNC viewer URL
    - browser-spice: Returns urlp with spice-web-client URL
    - browser-rdp: Returns viewer URL for RDP (requires cookie/jwt)
    - file-spice: Returns vv file content for virt-viewer
    - file-rdpgw: Returns RDP file with gateway settings
    - file-rdpvpn: Returns RDP file for VPN connection
    """
    import base64
    
    url = f"{API_BASE_URL}/desktop/{vm_id}/viewer/{viewer_type}"
    headers = get_api_headers()
    if not headers:
        return None
    try:
        response = requests.get(url, headers=headers)
        response.raise_for_status()
        
        data = response.json()
        print(f"DEBUG viewer response for {viewer_type}: {json.dumps(data, indent=2)}")
        
        if isinstance(data, dict):
            # Handle file-type viewers (SPICE, RDP files)
            if data.get("kind") == "file":
                content = data.get("content", "")
                protocol = data.get("protocol", "")
                ext = data.get("ext", "txt")
                
                if protocol == "spice" or ext == "vv":
                    return {
                        "type": "spice_file",
                        "content": content,
                        "filename": f"desktop-{vm_id}.vv",
                        "mime": data.get("mime", "application/x-virt-viewer")
                    }
                elif protocol in ["rdpgw", "rdpvpn"] or ext == "rdp":
                    return {
                        "type": "rdp_file",
                        "content": content,
                        "filename": f"desktop-{vm_id}.rdp",
                        "mime": data.get("mime", "application/x-rdp")
                    }
            
            # Handle browser-type viewers
            if data.get("kind") == "browser":
                # The API returns urlp with the full viewer URL
                urlp = data.get("urlp")
                if urlp and urlp != "Not implemented":
                    return {"type": "url", "url": urlp}
                
                # Fallback to viewer field
                viewer = data.get("viewer")
                if viewer:
                    return {"type": "url", "url": viewer}
            
            # Direct urlp field (common response format)
            urlp = data.get("urlp")
            if urlp and urlp != "Not implemented":
                return {"type": "url", "url": urlp}
            
            # For browser-rdp, we might need to construct the URL with cookie
            if viewer_type == "browser-rdp" and data.get("protocol") == "rdp":
                cookie = data.get("cookie", "")
                viewer_url = data.get("viewer", "")
                if viewer_url and cookie:
                    # Check if URL already has parameters
                    separator = "&" if "?" in viewer_url else "?"
                    return {"type": "url", "url": f"{viewer_url}{separator}cookie={cookie}"}
                elif viewer_url:
                    return {"type": "url", "url": viewer_url}
            
            # For file-spice, check if we got spice file content in different format
            if viewer_type == "file-spice":
                # Try to build SPICE vv file from data
                if data.get("values") or data.get("cookie"):
                    values = data.get("values", {})
                    if not values and data.get("cookie"):
                        try:
                            cookie_data = base64.b64decode(data.get("cookie", ""))
                            cookie_json = json.loads(cookie_data)
                            values = cookie_json.get("web_viewer", {})
                        except Exception:
                            pass
                    
                    if values:
                        proxy_host = values.get("host", "")
                        proxy_port = values.get("port", "443")
                        vm_host = values.get("vmHost", "")
                        vm_port = values.get("vmPort", "")
                        password = values.get("token", "")
                        vm_name = values.get("vmName", f"desktop-{vm_id}")
                        
                        # Build virt-viewer file format
                        spice_content = f"""[virt-viewer]
type=spice
proxy=http://{proxy_host}:{proxy_port}
host={vm_host}
password={password}
tls-port={vm_port}
fullscreen=0
title={vm_name} - Press SHIFT+F12 to exit
delete-this-file=1
"""
                        return {
                            "type": "spice_file",
                            "content": spice_content,
                            "filename": f"desktop-{vm_id}.vv",
                            "mime": "application/x-virt-viewer"
                        }
            
            # For file-rdpgw or file-rdpvpn, build RDP file from data
            if viewer_type in ["file-rdpgw", "file-rdpvpn"]:
                content = data.get("content")
                if content:
                    return {
                        "type": "rdp_file",
                        "content": content,
                        "filename": f"desktop-{vm_id}.rdp",
                        "mime": "application/x-rdp"
                    }
                
                # Try to build from cookie/values
                values = data.get("values", {})
                cookie = data.get("cookie", "")
                
                if not values and cookie:
                    try:
                        # Try JWT decode
                        parts = cookie.split(".")
                        if len(parts) >= 2:
                            payload = parts[1]
                            payload += "=" * (4 - len(payload) % 4)
                            decoded = json.loads(base64.urlsafe_b64decode(payload))
                            values = decoded.get("web_viewer", {})
                    except Exception:
                        pass
                
                if values:
                    vm_host = values.get("vmHost", "")
                    vm_username = values.get("vmUsername", "")
                    vm_password = values.get("vmPassword", "")
                    gateway_host = values.get("host", "")
                    gateway_port = values.get("port", "443")
                    
                    rdp_content = f"""full address:s:{vm_host}
gatewayhostname:s:{gateway_host}:{gateway_port}
gatewayaccesstoken:s:{cookie}
username:s:{vm_username}
password 51:b:{vm_password}
enableworkspacereconnect:i:0
disable wallpaper:i:0
allow desktop composition:i:0
disable full window drag:i:1
disable menu anims:i:1
disable themes:i:0
disable cursor setting:i:0
bitmapcachepersistenable:i:1
audiomode:i:0
redirectprinters:i:1
redirectcomports:i:0
redirectsmartcards:i:1
redirectclipboard:i:1
redirectposdevices:i:0
drivestoredirect:s:
autoreconnection enabled:i:1
authentication level:i:2
prompt for credentials:i:0
negotiate security layer:i:1
remoteapplicationmode:i:0
alternate shell:s:
shell working directory:s:
gatewayusagemethod:i:1
gatewaycredentialssource:i:5
gatewayprofileusagemethod:i:1
networkautodetect:i:1
bandwidthautodetect:i:1
promptcredentialonce:i:0
gatewaybrokeringtype:i:0
use redirection server name:i:0
rdgiskdcproxy:i:0
kdcproxyname:s:
connection type:i:6
domain:s:
allow font smoothing:i:1
bitmapcachesize:i:32000
smart sizing:i:1
"""
                    return {
                        "type": "rdp_file",
                        "content": rdp_content,
                        "filename": f"desktop-{vm_id}.rdp",
                        "mime": "application/x-rdp"
                    }
            
            # Fallback to direct viewer URL or other fields
            viewer = data.get("viewer") or data.get("url") or data.get("uri")
            if viewer:
                return {"type": "url", "url": viewer}
            
            # Return raw data if nothing else works
            return data
        
        return data
            
    except requests.exceptions.HTTPError as e:
        print(f"HTTP Error al obtener viewer para {vm_id} ({viewer_type}): {e}")
        print(f"Response: {e.response.text if e.response else 'No response'}")
        return None
    except Exception as e:
        print(f"Error al obtener viewer para {vm_id} ({viewer_type}): {e}")
        import traceback
        traceback.print_exc()
        return None


def api_action(vm_id, action):
    """
    Realiza una acci칩n (start/stop) usando el m칠todo GET y la ruta invertida.
    Ej: GET /api/v3/desktop/start/{id}
    """

    # 游뚿 LA RUTA CORRECTA 游뚿
    url = f"{API_BASE_URL}/desktop/{action}/{vm_id}"
    
    headers = get_api_headers()
    if not headers:
        return False, "No hay API Key configurada"

    try:
        # Usamos GET para las acciones, como descubriste
        response = requests.get(url, headers=headers)
        if handle_api_error(response):
            return False, "API Key inv치lida o expirada"
        response.raise_for_status()

        # Opcionalmente, podemos esperar y actualizar el estado
        # Aunque IsardVDI requiere un tiempo para el cambio.

        return (
            True,
            f"Orden '{action.upper()}' enviada. Verifica el estado en unos segundos.",
        )

    except requests.exceptions.HTTPError as e:
        return False, f"Error HTTP al {action}. Ruta probada: {url}. Error: {e}"
    except Exception as e:
        return False, f"Error de conexi칩n: {e}"


# ... (Las funciones get_status_html y las rutas Flask siguen igual) ...


def get_status_html(status):
    """Devuelve el HTML formateado seg칰n el estado."""

    status_map = {
        "Started": ("En Marcha", "success"),
        "Stopped": ("Apagada", "danger"),
        "Starting": ("Arrancando", "warning"),
        "Stopping": ("Apagando", "warning"),
        "Error": ("Error", "dark"),
        "Deploying": ("Desplegando", "primary"),
        "Unknown": ("Desconocido", "secondary"),
    }

    text, color = status_map.get(status, ("Desconocido", "secondary"))
    return f'<span class="badge bg-{color}">{text}</span>'


# ==============================================================================
# RUTAS DE FLASK
# ==============================================================================

HTML_TEMPLATE = """
<!doctype html>
<html lang="es">
<head>
    <link rel="icon" href="data:image/x-icon;base64,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/wD8A/8A/Af/APwH/wD+B/8A/gf/AP+H/wD8B/8A/A//AP4P/wAoAAAAIAAAAEAAAAABACAAAAAAAAAQAADpDgAA6Q4AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAsAAAAwAAAAWQAAAHAAAAAjAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABIAAABfAAAAtgAAAOYAAAD5AAAA/AAAAFYAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEAAAA9AAAAvQAAAPoAAAD/AAAA/wAAAP8AAAD+AAAAXQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABAAAAVwAAAOQAAAD/AAAA/wAAAP8AAAD/AAAA/wAAAPsAAABRAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEwAAADoAAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA7wAAADUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAjAAAA0gAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAADOAAAAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAQAAAIsAAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAIcAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAkAAAA3wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8GBgboDg4PMQ8QEQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAGIAAAD+AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AwMD/2RpauzK1NhBvsjLAMjS1gAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAlwAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP9HS0z9vsfL/8nT18DI0tYeyNLWAMjS1gAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAYAAAC3AAAA/wAAAP8AAAD/AAAA/wAAAP8CAgL/RkpL/bfAw/7K1Nj/yNLW/8jS1rnI0tYwyNLWAcjS1gAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACgAAAMEAAAD/AAAA/wAAAP8AAAD/AwMD/1VZW/28xsr+ytTY/8jS1v/I0tb/yNLW/8jS1uLI0taMydTYRsrU2SrJ1Ngby9TWA8vU1gAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAHAAAAugAAAP8AAAD/AAAA/wAAAP9NUVL9wMnN/snU2P/I0tb/yNLW/8nT1//L1dn/ytTY/8bQ1P/By8/3wcvO6MjR09jQ2dmA4erqC97n5wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEAAACfAAAA/wAAAP8AAAD/KSss/bO8v/7K1Nj/yNLW/8nT1//K1dn/u8XJ/5GYm/9iZ2n/QkVH/zM1Nv8xMzP+QEND/15iYvdfY2NVcnd3AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAG0AAAD/AAAA/wUFBf6CiYv9y9XZ/8jS1v/K1Nj/wcrO/4CGiP8vMTL/BwcI/wAAAP8AAAD/CgsL/icpKv09QEH/Oz4//ywuL4E/QkMAAwMEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAALgAAAOcAAAD/LC4v/bvFyP7J09f/ytTY/7K6vv9JTU7/BgYG/wAAAP8AAAD/CQoK/k9TVP2dpKj+vcbK+sXP09HBy8+TrbW5M8LM0AAUFRYAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEAAAAngAAAP9jaGr9ytTY/8rU2P+wuLz/NTc4/wAAAP8AAAD/AAAA/w4PD/56gIP9xc/T/svW2tDK1NhjytTYF9Te4wHP2d0AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAzBQUF4YyTlf/M1tr/vMbK/0JFR/8XGBj/ODs8/xAREf8CAgP+bnN1/cnT1/rJ09eeyNLWH8jS1gDI0tYAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAP///wAeHyBmpq+y9c3X2/+Ei43+BAQE/2Zrbf++yMv/VFha/y4wMf27xcj7ytTYj8jS1gzI0tYAzs/QAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAJigoABITExl4foDWyNLW/5ujpv0LDAz+ERIT/zM1Nv8RERL/bnR2/83X26nI0tYPyNLWAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEktPUM7DzdH/u8TI/iUnKP0AAAD/AAAA/wgICP+Mk5bd2eToLcjS1gDI0dYAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAHVVlbtsLM0P/G0NT6Sk5PtAAAANoAAAD/CwwM/3V7fX8AAAAAyNLWAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAP///wBLT1CGucLG/8nT1/PO2Nw5AAAATQAAAPgCAgL6ERITTQoKCgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAMzY3ACgqK0Ofpqr0y9XZ3ODr8BoAAAAyAAAA8AAAAP8AAABqAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEBQUAAAAADGZrbbe5wsabAAAAAAAAADIAAADvAAAA/wAAAIIAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA9QEEAICEiN1ZaXCoTFBUAAAAAQgAAAPYAAAD/AAAAhQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABoAAAA/wAAAP8AAAB0AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABgAAAKkAAAD/AAAA+gAAAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABVAAAA6QAAAO0AAADfAAAAIgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAgAAAC0AAABIAAAAeQAAANAAAACuAAAA4gAAAJEAAAACAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFwAAAGkAAACfAAAAigAAALwAAACpAAAAGgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABgAAAEkAAACHAAAAZQAAABEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAP/4P///4D///4A///8AP///AD///gA///wAf//8AH///AB///wAP//4AA//+AAA//gAAH/4AAB//AAAf/wAAH/8AAD//gAH//8AD///AB///wA///8Af///gH///4B///+If///yH///8h////wf///MH///wB///+A////wf//KAAAAEAAAACAAAAAAQAgAAAAAAAAQAAA6Q4AAOkOAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABAAAABgAAAAsAAAAGAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAGAAAAIgAAAE0AAAB4AAAAmwAAALIAAADBAAAAXwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAQAAABsAAABgAAAArQAAAOEAAAD5AAAA/wAAAP8AAAD/AAAA/wAAAJQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAHQAAAHoAAADVAAAA/AAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAClAAAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAJAAAAXgAAANEAAAD+AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAArAAAAAMAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAeAAAAngAAAPcAAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAKoAAAACAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAyAAAAxAAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAACdAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA5AAAA0wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAAhgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAvAAAA0QAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAGUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAaAAAAvgAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAPMAAAA9AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAGAAAAkwAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAADVAAAAGAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUQAAAPIAAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAAnQAAAAIAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAAAMMAAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA+AAAAFIAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAGUAAAD8AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAMkAAAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABAAAADCAAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP0AAABsAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABJAAAA9QAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8MDQ3SGxwdGhcYGAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAkgAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8KCwv/gYeK39bh5S3K1NgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEgAAAMwAAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD+Vlpc+8XP0//J09eZyNLWBsjS1gAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADMAAADuAAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/NDc4+7a/w/zJ1Nj/yNLW88jS1lvI0tUAyNLWAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABXAAAA/AAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/Jigo+6evsvvK1Nj/yNLW/8jS1v/I0tbgyNLWQsjS1gDI0tYAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAeAAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/JSco+6CorPvK1Nj/yNLW/8jS1v/I0tb/yNLW/8jS1tvI0tZJyNLWAcjS1gAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAI4AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/MTQ1+6evsvvK1Nj/yNLW/8jS1v/I0tb/yNLW/8jS1v/I0tb/yNLW6cjS1nXI0tYRyNLWAMnS1QAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACaAAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8BAQH+QkZH+rK7vvzK1Nn/yNLW/8jS1v/I0tb/yNLW/8jS1v/I0tb/yNLW/8jS1v/I0tb7yNLWv8jS1lnI0tYVyNLVAcjS1gAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAnAAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8BAQH+S09Q+7vEyP3K1Nj/yNLW/8jS1v/I0tb/yNLW/8jS1v/I0tb/yNLW/8jS1v/I0tb/yNLW/8jS1v/I0tb5yNLWz8jS1pHI0tZcyNLWPMjS1i7I0tYmx9HWD8HO1gDE0NYAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAJQAAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/Q0dI+7vEyP3K1Nj/yNLW/8jS1v/I0tb/yNLW/8jS1v/I0tb/yNLW/8jS1v/I0tb/yNLW/8jS1v/I0tb/yNLW/8jS1v/I0tb/yNLW/cjS1vTI0tbsyNLW5crT1sPM1dVszNXVD8zV1QAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACBAAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/LTAx+7K7vvzK1Nj/yNLW/8jS1v/I0tb/yNLW/8jS1v/I0tb/yNLW/8jS1v/I0tb/yNLW/8jS1v/J09f/y9XZ/8vW2v/L1dn/ytTY/8nT1//J09f+y9XY/M7X2fzP2Nn/z9jY/M7X15zO19cPztfXAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAZAAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/EhMU/Zmgo/vL1dn/yNLW/8jS1v/I0tb/yNLW/8jS1v/I0tb/yNLW/8jS1v/I0tb/ydPX/8vV2f/H0dX/uMHE/56mqf+CiIv/am9x/1peYP9SVlj/UFRV+1hcXPdrb2/7g4mJ+6GoqPy8xMT6ydLSbbfAwADd5eUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEAAAAD1AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AQEB/mhtb/rJ09f+yNLW/8jS1v/I0tb/yNLW/8jS1v/I0tb/yNLW/8jS1v/K1Nj/ytTY/7fAw/+HjZD/TlJU/yMlJv8MDA3/AgIC/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wEBAf4LCwv9JSYm/z5BQcMnKSkPISMjAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAdAAAA2wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/yksLPy3wMT9ydPX/8jS1v/I0tb/yNLW/8jS1v/I0tb/yNLW/8nT1//K1Nj/sbq9/2twc/8mKCj/BQUF/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD+AAAA/gAAAP8AAADlAAAAJQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABAAAAKoAAAD/AAAA/wAAAP8AAAD/AAAA/wMDA/57gYP7y9XZ/8jS1v/I0tb/yNLW/8jS1v/I0tb/yNLW/8rU2P+/yMz/eH6A/yIkJP8BAQH/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wEBAf4PEBD8MDM0+lNXWflscXP7dnx++nR6fPtjaGr/QkZH5CMlJiUmKCgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABjAAAA/QAAAP8AAAD/AAAA/wAAAP8mJyj8t8DE/cnT1//I0tb/yNLW/8jS1v/I0tb/yNLW/8rU2P+osLP/QkVG/wUFBf8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AQEB/iAhIvtnbG75o6uv+8DKzv3J09f+y9XZ/8vW2v/L1tr7y9XZ5cXP05+0vcENtr/DAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAIQAAANoAAAD/AAAA/wAAAP8AAAD/ZGlr+8rU2P/I0tb/yNLW/8jS1v/I0tb/yNLW/8nT1/+SmZz/IiQk/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/DA0N/V1iZPqxur38ytTY/8rU2P/J09f/yNLW/sjS1uHI0taeyNLWV8jS1iXL1dkJABUiAOLp6wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACKAAAA/wAAAP8AAAD/CwwM/Zykp/vL1dn/yNLW/8jS1v/I0tb/yNLW/8nT1/+HjpD/FRYX/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/Ghsc/ImQkvvH0dX+ytTY/8jS1v/I0tb+yNLW18jS1nnI0tYmyNLWA8jS1gAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAALAAAAOAAAAD/AAAA/ykrLPy8xcn9ydPX/8jS1v/I0tb/yNLW/8rU2P+LkpX/ExQV/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/Gx0d/JefovvL1dn/yNLW/8jS1v/I0tbsyNLWicjS1iHI0dUAyNLWAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAB9AAAA/gAAAP9PU1T7yNLW/sjS1v/I0tb/yNLW/8rU2f+epqn/Gx0d/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/Dg8P/IyTlfrL1dn/yNLW/8jS1v/I0tbJyNLWRMjS1gPI0tYAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFwAAAMEAAAD/cXd5+8vV2f/I0tb/yNLW/8nT1/+2v8P/MzU2/wAAAP8EBAT/ODs8/2xydP9gZGb/HiAg/wAAAP8AAAD/AQEB/mNoavrI0tb+yNLW/8jS1v3I0tapyNLWIMjS1gDI0tUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA+AwME44qQk/zL1dn/yNLW/8jS1v/G0NT/YGVm/wEBAf8AAAD/QUVG/77Hy//M1tr/y9XZ/6GprP8dHh//AAAA/yYoKfu1vsL8ydPY/8jS1vzI0taayNLWEsjS1gDJ09YAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQVFWCgqKvwy9XZ/8jS1v/J09f/vsjM/jAyM/wAAAD/AAAA/y4xMv+ttbn/ytXZ/8rV2f+psbT/IyUl/wAAAP5xd3n6y9XZ/8jS1v/I0tagyNLWEMjS1gAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACEjJAALDAwRbXN1yb7IzP/J09f/yNLW/8rU2P9qb3H6AAAA/gAAAP8AAAD/JCUm/1tgYv9aXmD/ISMk/wAAAP8WFxj8rLS4/MrU2P/I0ta6yNLWGcjS1gAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEAQEBMtwdnj9ytTY/8jS1v/K1Nn/oams+w0ODvwAAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/PkFC+8TO0v/I0tbdyNLWMsjS1gDI0tYAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAwAAADFZWps/svV2f/I0tb/ydPX/7zGyv0pKyv7AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/2Rpa/rL1dn5yNLWacnS1gDI0tYAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAGAAAAtXJ3ev/L1tr/yNLW/8jS1v/H0dX+REdJ+gAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP5+hIf9zdfbt8jS1g/I0tYAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACgoKAAAAAJlyeHr/y9ba/8jS1v/I0tb/ytTY/11iZOoAAAD3AAAA/wAAAP8AAAD/AAAA/wAAAP8DAwP+ho2P79Pd4k3I0tYAydLWAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAByZ2xu/MvV2f/I0tb/yNLW/8nT1/+wubyGAAAAVAAAALAAAADwAAAA/wAAAP8AAAD/BAUF/250drP///8MyNLWAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAARFBUVvHI0tb/yNLW/8jS1v/I0tb/yNLWbbvEyAAAAAAGAAAAkAAAAP8AAAD/AAAA/wICAv8hIyN2AAAAAO3y9AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABozNTbSu8TI/8nT1//I0tb/yNLW/MjS1lTI0tYAAAAAAAAAAGYAAAD/AAAA/wAAAP8AAAD/AAAAiQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABExQUlpmhpP/L1dn/yNLW/8jS1uzI0tYwyNLWAAAAAAAAAABRAAAA+wAAAP8AAAD/AAAA/wAAALMAAAAGAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAgICAAAAAEleY2XxyNLW/8jS1v/I0tbDyNLWDsjS1gAAAAAAAAAARwAAAPgAAAD/AAAA/wAAAP8AAADPAAAAEgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAOICIiuaWtsf/K1Nj/yNLWeMjS1gDI0tYAAAAAAAAAAEYAAAD4AAAA/wAAAP8AAAD/AAAA3wAAAB4AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABAQEAAAAAFdQVFb2wMrO3MvV2SbI0tYAAAAAAAAAAAAAAABNAAAA+gAAAP8AAAD/AAAA/wAAAOcAAAAnAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAMDg8PqltgYnYAAAAAyNLWAAAAAAAAAAAAAAAAXwAAAP4AAAD/AAAA/wAAAP8AAADpAAAAKQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAB0AAAARAAAAAAAAAAAAAAAAAAAAAAAAAH0AAAD/AAAA/wAAAP8AAAD/AAAA5QAAACQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAIAAACkAAAA/wAAAP8AAAD/AAAA/wAAANsAAAAaAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUAAAAzwAAAP8AAAD/AAAA/wAAAP8AAADHAAAADQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAPwAAAPIAAAD/AAAA/wAAAP8AAAD/AAAApgAAAAIAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAQAAAJEAAAD/AAAA/wAAAP8AAAD/AAAA/wAAAHQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADwAAADnAAAA/wAAAPUAAAD3AAAA/wAAAPIAAAA+AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACIAAADCAAAA/wAAAPkAAAC8AAAA8QAAAP8AAADJAAAAEgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAIAAAAUAAAABgAAAAAAAAAAAAAABAAAADoAAADAAAAA/wAAAPwAAAChAAAAqAAAAP8AAAD/AAAAdgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAANQAAAIgAAAB/AAAAfwAAAKwAAADsAAAA/wAAAOkAAAB+AAAAYwAAAO8AAAD/AAAAxgAAABoAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAIAAAA5AAAAnwAAANYAAADdAAAAxQAAAIcAAAA4AAAATwAAAN0AAAD/AAAA2wAAAD0AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAMAAAA9AAAAagAAAFIAAABYAAAAmwAAAO8AAAD+AAAAxAAAADsAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACwAAAF8AAAC2AAAA3wAAAOcAAADCAAAAbwAAABgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADwAAACgAAAApAAAAEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD////+H////////+Af////////AB////////4AD///////+AAP///////wAA///////+AAD///////wAAf//////+AAB///////wAAH//////+AAAf//////4AAB///////AAAP//////8AAA///////gAAH//////+AAAf//////4AAB///////AAAD//////8AAAP//////wAAAf//////AAAAf/////8AAAA//////wAAAAf/////AAAAAB////8AAAAAD////wAAAAAH////AAAAAAf///8AAAAAA////wAAAAAD////AAAAAAP///+AAAAAA////4AAAAAH////gAAAAD/////AAAAA/////8AAAAP/////4AAAD//////wAAAf//////AAAD//////+AAAf//////4AAD///////gAAf//////+AAB///////8AAP///////wAA////////AQH///////8Bgf///////wGA////////gYD///////+DgP///////8OA////////x4D////////ngP////////8A/////////wD/////////AP////////4B/////////gH////////8Af///////jAD////////AAP///////8AB////////8AP////////4B/////////wP/////w==">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>IsardVDI Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            padding: 2rem;
            margin-top: 2rem;
            margin-bottom: 2rem;
        }
        .header {
            background: linear-gradient(45deg, #1e3c72, #2a5298);
            color: white;
            padding: 2rem;
            border-radius: 15px;
            margin-bottom: 2rem;
            text-align: center;
        }
        .vm-card {
            border: none;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            margin-bottom: 1rem;
        }
        .vm-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        .btn-custom {
            border-radius: 25px;
            padding: 0.5rem 1.5rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        .btn-success:hover {
            background-color: #28a745;
            transform: scale(1.05);
        }
        .btn-danger:hover {
            background-color: #dc3545;
            transform: scale(1.05);
        }
        .status-badge {
            font-size: 0.85rem;
            padding: 0.5rem 1rem;
            border-radius: 20px;
        }
        .refresh-controls {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            align-items: flex-end;
        }
        .refresh-btn {
            border-radius: 50%;
            width: 60px;
            height: 60px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
        }
        .refresh-btn:hover {
            transform: scale(1.1);
        }
        .auto-refresh-toggle {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: white;
            padding: 0.5rem 1rem;
            border-radius: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            font-size: 0.85rem;
        }
        .auto-refresh-toggle label {
            margin: 0;
            cursor: pointer;
            user-select: none;
        }
        .form-check-input:checked {
            background-color: #667eea;
            border-color: #667eea;
        }
        .folder-section {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border-left: 4px solid #667eea;
        }
        .folder-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            cursor: pointer;
        }
        .folder-header h4 {
            margin: 0;
            color: #1e3c72;
        }
        .folder-actions {
            display: flex;
            gap: 0.5rem;
        }
        .folder-content {
            padding-top: 0.5rem;
        }
        .unassigned-section {
            border-left-color: #6c757d;
        }
        .create-folder-form {
            background: #e9ecef;
            padding: 1rem;
            border-radius: 10px;
            margin-bottom: 1.5rem;
        }
        .folder-badge {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
        }
        .assign-dropdown {
            font-size: 0.85rem;
        }
        .vm-info-section {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 0.5rem;
            margin-bottom: 0.5rem;
            font-size: 0.85rem;
        }
        .vm-info-section .info-label {
            color: #6c757d;
            font-weight: 600;
            font-size: 0.75rem;
            text-transform: uppercase;
        }
        .vm-info-section .info-value {
            color: #495057;
            word-break: break-all;
        }
        .spice-btn {
            font-size: 0.8rem;
            padding: 0.25rem 0.75rem;
        }
        .ip-badge {
            font-family: monospace;
            font-size: 0.8rem;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .spinning i {
            animation: spin 0.5s linear;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="mb-2"><i class="fas fa-server me-3"></i>IsardVDI Dashboard</h1>
                    <p class="mb-0">Gesti칩n de m치quinas virtuales</p>
                </div>
                <div>
                    <a href="{{ url_for('logout') }}" class="btn btn-outline-light btn-sm">
                        <i class="fas fa-sign-out-alt me-2"></i>Cerrar Sesi칩n
                    </a>
                </div>
            </div>
        </div>

        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <div class="row">
                    <div class="col-12">
                        {% for category, message in messages %}
                            <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                                <i class="fas fa-info-circle me-2"></i>{{ message }}
                                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            {% endif %}
        {% endwith %}

        <!-- Formulario para crear nueva carpeta -->
        <div class="create-folder-form">
            <form action="{{ url_for('create_folder') }}" method="POST" class="d-flex gap-2 align-items-center">
                <i class="fas fa-folder-plus text-primary fa-lg"></i>
                <input type="text" name="folder_name" class="form-control" placeholder="Nombre de la nueva carpeta..." required>
                <button type="submit" class="btn btn-primary btn-custom">
                    <i class="fas fa-plus me-1"></i>Crear Carpeta
                </button>
            </form>
        </div>

        <!-- Carpetas con m치quinas -->
        {% for folder_id, folder in folders.items() %}
        <div class="folder-section">
            <div class="folder-header" data-bs-toggle="collapse" data-bs-target="#folder-{{ folder_id }}">
                <h4>
                    <i class="fas fa-folder-open me-2 text-warning"></i>{{ folder.name }}
                    <span class="badge bg-secondary folder-badge ms-2" id="folder-{{ folder_id }}-count">{{ folder.machines|length }} m치quinas</span>
                </h4>
                <div class="folder-actions" onclick="event.stopPropagation();">
                    <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#renameModal{{ folder_id }}" title="Renombrar">
                        <i class="fas fa-edit"></i>
                    </button>
                    <a href="{{ url_for('delete_folder', folder_id=folder_id) }}" class="btn btn-sm btn-outline-danger" title="Eliminar carpeta" onclick="return confirm('쮼st치s seguro de eliminar esta carpeta? Las m치quinas no se eliminar치n.');">
                        <i class="fas fa-trash"></i>
                    </a>
                </div>
            </div>
            <div class="folder-content collapse show" id="folder-{{ folder_id }}">
                <div class="row">
                    {% for vm_id, vm in folder.machines.items() %}
                    <div class="col-lg-6 col-xl-4 mb-3">
                        <div class="card vm-card h-100" data-vm-id="{{ vm.id }}">
                            <div class="card-body d-flex flex-column">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <h5 class="card-title mb-0">
                                        <i class="fas fa-desktop me-2 text-primary"></i>{{ vm.name }}
                                    </h5>
                                    <span class="vm-status">{{ vm.status_html|safe }}</span>
                                </div>
                                <p class="card-text text-muted mb-2">
                                    <i class="fas fa-hashtag me-1"></i>ID: <code>{{ vm.id }}</code>
                                </p>
                                <!-- IP Addresses -->
                                <div class="vm-info-section">
                                    <div class="info-label"><i class="fas fa-network-wired me-1"></i>IPs</div>
                                    <div class="info-value vm-ips">
                                        {% if vm.ips %}
                                            {% for ip in vm.ips %}
                                                <span class="badge bg-info ip-badge me-1">{{ ip }}</span>
                                            {% endfor %}
                                        {% else %}
                                            <span class="text-muted">No disponible</span>
                                        {% endif %}
                                    </div>
                                </div>
                                <!-- Viewer Connection -->
                                <div class="vm-info-section viewer-section" style="{% if vm.status != 'Started' %}display: none;{% endif %}" data-vm-id="{{ vm.id }}" data-vm-name="{{ vm.name }}">
                                    <div class="info-label"><i class="fas fa-plug me-1"></i>Conectar</div>
                                    <div class="info-value">
                                        <div class="btn-group viewer-buttons" role="group">
                                            <span class="text-muted"><i class="fas fa-spinner fa-spin me-1"></i>Cargando...</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="mb-2">
                                    <div class="dropdown">
                                        <button class="btn btn-sm btn-outline-secondary dropdown-toggle assign-dropdown" type="button" data-bs-toggle="dropdown">
                                            <i class="fas fa-folder me-1"></i>Mover a...
                                        </button>
                                        <ul class="dropdown-menu">
                                            <li><a class="dropdown-item" href="{{ url_for('unassign_from_folder', vm_id=vm.id) }}"><i class="fas fa-times me-2"></i>Sin carpeta</a></li>
                                            <li><hr class="dropdown-divider"></li>
                                            {% for fid, f in folders.items() if fid != folder_id %}
                                            <li><a class="dropdown-item" href="{{ url_for('assign_to_folder', folder_id=fid, vm_id=vm.id) }}"><i class="fas fa-folder me-2"></i>{{ f.name }}</a></li>
                                            {% endfor %}
                                        </ul>
                                    </div>
                                </div>
                                <div class="mt-auto vm-action">
                                    {% if vm.status == 'Stopped' %}
                                        <a href="{{ url_for('start_vm', vm_id=vm.id) }}" class="btn btn-success btn-custom w-100">
                                            <i class="fas fa-play me-2"></i>Iniciar
                                        </a>
                                    {% elif vm.status == 'Started' %}
                                        <a href="{{ url_for('stop_vm', vm_id=vm.id) }}" class="btn btn-danger btn-custom w-100">
                                            <i class="fas fa-stop me-2"></i>Detener
                                        </a>
                                    {% else %}
                                        <button class="btn btn-secondary btn-custom w-100" disabled>
                                            <i class="fas fa-spinner fa-spin me-2"></i>{{ vm.status }}
                                        </button>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    {% else %}
                    <div class="col-12">
                        <p class="text-muted mb-0"><i class="fas fa-info-circle me-2"></i>Esta carpeta est치 vac칤a.</p>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Modal para renombrar carpeta -->
        <div class="modal fade" id="renameModal{{ folder_id }}" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <form action="{{ url_for('rename_folder', folder_id=folder_id) }}" method="POST">
                        <div class="modal-header">
                            <h5 class="modal-title"><i class="fas fa-edit me-2"></i>Renombrar Carpeta</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <input type="text" name="folder_name" class="form-control" value="{{ folder.name }}" required>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                            <button type="submit" class="btn btn-primary">Guardar</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        {% endfor %}

        <!-- M치quinas sin carpeta -->
        {% if unassigned_machines %}
        <div class="folder-section unassigned-section">
            <div class="folder-header" data-bs-toggle="collapse" data-bs-target="#unassigned-folder">
                <h4>
                    <i class="fas fa-inbox me-2 text-secondary"></i>Sin Carpeta
                    <span class="badge bg-secondary folder-badge ms-2" id="unassigned-count">{{ unassigned_machines|length }} m치quinas</span>
                </h4>
            </div>
            <div class="folder-content collapse show" id="unassigned-folder">
                <div class="row">
                    {% for vm_id, vm in unassigned_machines.items() %}
                    <div class="col-lg-6 col-xl-4 mb-3">
                        <div class="card vm-card h-100" data-vm-id="{{ vm.id }}">
                            <div class="card-body d-flex flex-column">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <h5 class="card-title mb-0">
                                        <i class="fas fa-desktop me-2 text-primary"></i>{{ vm.name }}
                                    </h5>
                                    <span class="vm-status">{{ vm.status_html|safe }}</span>
                                </div>
                                <p class="card-text text-muted mb-2">
                                    <i class="fas fa-hashtag me-1"></i>ID: <code>{{ vm.id }}</code>
                                </p>
                                <!-- IP Addresses -->
                                <div class="vm-info-section">
                                    <div class="info-label"><i class="fas fa-network-wired me-1"></i>IPs</div>
                                    <div class="info-value vm-ips">
                                        {% if vm.ips %}
                                            {% for ip in vm.ips %}
                                                <span class="badge bg-info ip-badge me-1">{{ ip }}</span>
                                            {% endfor %}
                                        {% else %}
                                            <span class="text-muted">No disponible</span>
                                        {% endif %}
                                    </div>
                                </div>
                                <!-- Viewer Connection -->
                                <div class="vm-info-section viewer-section" style="{% if vm.status != 'Started' %}display: none;{% endif %}" data-vm-id="{{ vm.id }}" data-vm-name="{{ vm.name }}">
                                    <div class="info-label"><i class="fas fa-plug me-1"></i>Conectar</div>
                                    <div class="info-value">
                                        <div class="btn-group viewer-buttons" role="group">
                                            <span class="text-muted"><i class="fas fa-spinner fa-spin me-1"></i>Cargando...</span>
                                        </div>
                                    </div>
                                </div>
                                {% if folders %}
                                <div class="mb-2">
                                    <div class="dropdown">
                                        <button class="btn btn-sm btn-outline-secondary dropdown-toggle assign-dropdown" type="button" data-bs-toggle="dropdown">
                                            <i class="fas fa-folder me-1"></i>Asignar a...
                                        </button>
                                        <ul class="dropdown-menu">
                                            {% for fid, f in folders.items() %}
                                            <li><a class="dropdown-item" href="{{ url_for('assign_to_folder', folder_id=fid, vm_id=vm.id) }}"><i class="fas fa-folder me-2"></i>{{ f.name }}</a></li>
                                            {% endfor %}
                                        </ul>
                                    </div>
                                </div>
                                {% endif %}
                                <div class="mt-auto vm-action">
                                    {% if vm.status == 'Stopped' %}
                                        <a href="{{ url_for('start_vm', vm_id=vm.id) }}" class="btn btn-success btn-custom w-100">
                                            <i class="fas fa-play me-2"></i>Iniciar
                                        </a>
                                    {% elif vm.status == 'Started' %}
                                        <a href="{{ url_for('stop_vm', vm_id=vm.id) }}" class="btn btn-danger btn-custom w-100">
                                            <i class="fas fa-stop me-2"></i>Detener
                                        </a>
                                    {% else %}
                                        <button class="btn btn-secondary btn-custom w-100" disabled>
                                            <i class="fas fa-spinner fa-spin me-2"></i>{{ vm.status }}
                                        </button>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Mensaje si no hay m치quinas -->
        {% if not maquinas %}
        <div class="text-center py-5">
            <i class="fas fa-server fa-4x text-muted mb-3"></i>
            <h4 class="text-muted">No hay m치quinas disponibles</h4>
            <p class="text-muted">Las m치quinas virtuales aparecer치n aqu칤 cuando est칠n disponibles.</p>
        </div>
        {% endif %}
    </div>

    <div class="refresh-controls">
        <div class="auto-refresh-toggle">
            <div class="form-check form-switch mb-0">
                <input class="form-check-input" type="checkbox" id="autoRefreshToggle">
                <label class="form-check-label" for="autoRefreshToggle">Auto-refresh</label>
            </div>
        </div>
        <a href="{{ url_for('index') }}" class="btn btn-primary refresh-btn" title="Actualizar" id="refreshBtn">
            <i class="fas fa-sync-alt"></i>
        </a>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Open VNC viewer - redirects through our server which sets the cookie
        function openViewer(vmId, vmName) {
            // Open via our redirect endpoint which will handle the cookie
            window.open(`/viewer/${vmId}/browser-vnc`, '_blank');
        }
        
        // Load available viewers for a VM
        async function loadViewerButtons(viewerSection) {
            const vmId = viewerSection.dataset.vmId;
            const vmName = viewerSection.dataset.vmName;
            const btnGroup = viewerSection.querySelector('.viewer-buttons');
            
            if (!vmId || !btnGroup) return;
            
            try {
                const response = await fetch(`/api/viewers/${vmId}`);
                const data = await response.json();
                
                let buttons = [];
                
                if (data.vnc) {
                    buttons.push(`<button onclick="openViewer('${vmId}', '${vmName}')" class="btn btn-sm btn-info spice-btn" title="Abrir VNC en navegador">
                        <i class="fas fa-desktop me-1"></i>Navegador
                    </button>`);
                }
                
                if (data.spice) {
                    buttons.push(`<a href="/viewer/${vmId}/file-spice" class="btn btn-sm btn-warning spice-btn" title="Descargar archivo .vv para virt-viewer">
                        <i class="fas fa-download me-1"></i>SPICE
                    </a>`);
                }
                
                if (data.rdp) {
                    buttons.push(`<a href="/viewer/${vmId}/file-rdpgw" class="btn btn-sm btn-success spice-btn" title="Descargar archivo .rdp">
                        <i class="fas fa-download me-1"></i>RDP
                    </a>`);
                }
                
                if (buttons.length > 0) {
                    btnGroup.innerHTML = buttons.join('');
                } else {
                    btnGroup.innerHTML = '<span class="text-muted">No hay visores disponibles</span>';
                }
            } catch (error) {
                console.error('Error loading viewers:', error);
                btnGroup.innerHTML = '<span class="text-muted">Error al cargar</span>';
            }
        }
        
        // Load viewers for all visible started VMs on page load
        function loadAllViewers() {
            document.querySelectorAll('.viewer-section').forEach(section => {
                if (section.style.display !== 'none') {
                    loadViewerButtons(section);
                }
            });
        }
        
        // Load viewers on page load
        document.addEventListener('DOMContentLoaded', loadAllViewers);

        // Auto-refresh functionality with AJAX (no page reload)
        let autoRefreshInterval = null;
        const REFRESH_INTERVAL = 5000; // 5 seconds
        
        // Status mapping for generating HTML badges
        const statusMap = {
            'Started': { text: 'En Marcha', color: 'success' },
            'Stopped': { text: 'Apagada', color: 'danger' },
            'Starting': { text: 'Arrancando', color: 'warning' },
            'Stopping': { text: 'Apagando', color: 'warning' },
            'Error': { text: 'Error', color: 'dark' },
            'Deploying': { text: 'Desplegando', color: 'primary' },
            'Unknown': { text: 'Desconocido', color: 'secondary' }
        };
        
        function getStatusBadge(status) {
            const info = statusMap[status] || { text: 'Desconocido', color: 'secondary' };
            return `<span class="badge bg-${info.color}">${info.text}</span>`;
        }
        
        function updateVMCard(vmId, vmData) {
            // Find all cards for this VM (could be in folder or unassigned)
            const cards = document.querySelectorAll(`[data-vm-id="${vmId}"]`);
            cards.forEach(card => {
                // Update status badge
                const statusContainer = card.querySelector('.vm-status');
                if (statusContainer) {
                    statusContainer.innerHTML = getStatusBadge(vmData.status);
                }
                
                // Update IPs
                const ipsContainer = card.querySelector('.vm-ips');
                if (ipsContainer) {
                    if (vmData.ips && vmData.ips.length > 0) {
                        ipsContainer.innerHTML = vmData.ips.map(ip => 
                            `<span class="badge bg-info ip-badge me-1">${ip}</span>`
                        ).join('');
                    } else {
                        ipsContainer.innerHTML = '<span class="text-muted">No disponible</span>';
                    }
                }
                
                // Update viewer section visibility and reload buttons if becoming visible
                const viewerSection = card.querySelector('.viewer-section');
                if (viewerSection) {
                    const wasHidden = viewerSection.style.display === 'none';
                    viewerSection.style.display = vmData.status === 'Started' ? 'block' : 'none';
                    
                    // If VM just started, reload the viewer buttons
                    if (wasHidden && vmData.status === 'Started') {
                        loadViewerButtons(viewerSection);
                    }
                }
                
                // Update action button
                const actionContainer = card.querySelector('.vm-action');
                if (actionContainer) {
                    if (vmData.status === 'Stopped') {
                        actionContainer.innerHTML = `
                            <a href="/start/${vmId}" class="btn btn-success btn-custom w-100">
                                <i class="fas fa-play me-2"></i>Iniciar
                            </a>`;
                    } else if (vmData.status === 'Started') {
                        actionContainer.innerHTML = `
                            <a href="/stop/${vmId}" class="btn btn-danger btn-custom w-100">
                                <i class="fas fa-stop me-2"></i>Detener
                            </a>`;
                    } else {
                        actionContainer.innerHTML = `
                            <button class="btn btn-secondary btn-custom w-100" disabled>
                                <i class="fas fa-spinner fa-spin me-2"></i>${vmData.status}
                            </button>`;
                    }
                }
            });
        }
        
        async function refreshData() {
            try {
                const response = await fetch('/api/vms');
                
                // Check if API Key is invalid (401)
                if (response.status === 401) {
                    const data = await response.json();
                    if (data.redirect) {
                        // Show alert and redirect to login
                        alert('Tu API Key ha expirado o ya no es v치lida. Ser치s redirigido al login.');
                        window.location.href = data.redirect;
                        return;
                    }
                }
                
                if (!response.ok) throw new Error('Error fetching data');
                const data = await response.json();
                
                // Update all VMs
                for (const [vmId, vmData] of Object.entries(data.vms)) {
                    updateVMCard(vmId, vmData);
                }
                
                // Update folder machine counts
                for (const [folderId, folderData] of Object.entries(data.folders)) {
                    const badge = document.querySelector(`#folder-${folderId}-count`);
                    if (badge) {
                        badge.textContent = `${Object.keys(folderData.machines).length} m치quinas`;
                    }
                }
                
                // Visual feedback that refresh happened
                const refreshBtn = document.getElementById('refreshBtn');
                refreshBtn.classList.add('spinning');
                setTimeout(() => refreshBtn.classList.remove('spinning'), 500);
                
            } catch (error) {
                console.error('Error refreshing data:', error);
            }
        }
        
        function startAutoRefresh() {
            if (autoRefreshInterval) return;
            autoRefreshInterval = setInterval(refreshData, REFRESH_INTERVAL);
        }
        
        function stopAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
            }
        }
        
        // Toggle handling
        const autoRefreshToggle = document.getElementById('autoRefreshToggle');
        const savedAutoRefresh = localStorage.getItem('autoRefresh') === 'true';
        autoRefreshToggle.checked = savedAutoRefresh;
        
        if (savedAutoRefresh) {
            startAutoRefresh();
        }
        
        autoRefreshToggle.addEventListener('change', function() {
            localStorage.setItem('autoRefresh', this.checked);
            if (this.checked) {
                startAutoRefresh();
            } else {
                stopAutoRefresh();
            }
        });
        
        // Folder collapse state persistence
        function saveCollapseStates() {
            const collapseStates = {};
            document.querySelectorAll('.folder-content').forEach(el => {
                collapseStates[el.id] = el.classList.contains('show');
            });
            localStorage.setItem('folderCollapseStates', JSON.stringify(collapseStates));
        }
        
        function restoreCollapseStates() {
            const saved = localStorage.getItem('folderCollapseStates');
            if (saved) {
                const collapseStates = JSON.parse(saved);
                document.querySelectorAll('.folder-content').forEach(el => {
                    if (collapseStates.hasOwnProperty(el.id)) {
                        if (collapseStates[el.id]) {
                            el.classList.add('show');
                        } else {
                            el.classList.remove('show');
                        }
                    }
                });
            }
        }
        
        // Restore collapse states on page load
        restoreCollapseStates();
        
        // Save collapse states when toggling folders
        document.querySelectorAll('.folder-header').forEach(header => {
            header.addEventListener('click', () => {
                setTimeout(saveCollapseStates, 350);
            });
        });
        
        // Manual refresh button - do AJAX refresh instead of page reload
        document.getElementById('refreshBtn').addEventListener('click', function(e) {
            e.preventDefault();
            refreshData();
        });
    </script>
</body>
</html>
"""

LOGIN_TEMPLATE = """
<!doctype html>
<html lang="es">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>IsardVDI Dashboard - Login</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .login-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 3rem;
            max-width: 500px;
            width: 100%;
        }
        .login-header {
            text-align: center;
            margin-bottom: 2rem;
        }
        .login-header h1 {
            color: #1e3c72;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }
        .login-header p {
            color: #6c757d;
        }
        .form-control {
            border-radius: 10px;
            padding: 0.75rem 1rem;
            border: 2px solid #e9ecef;
        }
        .form-control:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }
        .btn-login {
            background: linear-gradient(45deg, #667eea, #764ba2);
            border: none;
            border-radius: 10px;
            padding: 0.75rem;
            font-weight: 600;
            color: white;
            width: 100%;
            transition: transform 0.3s ease;
        }
        .btn-login:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
            color: white;
        }
        .api-key-input {
            position: relative;
        }
        .toggle-password {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            color: #6c757d;
        }
        .info-box {
            background: #e7f3ff;
            border-left: 4px solid #667eea;
            padding: 1rem;
            border-radius: 5px;
            margin-top: 1.5rem;
            font-size: 0.9rem;
        }
        .remember-box {
            margin: 1rem 0;
        }
    </style>
</head>
<body>
    <div class="login-card">
        <div class="login-header">
            <i class="fas fa-server fa-3x text-primary mb-3"></i>
            <h1>IsardVDI Dashboard</h1>
            <p>Introduce tu API Key para continuar</p>
        </div>

        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <form method="POST" action="{{ url_for('login') }}">
            <div class="mb-3">
                <label for="api_key" class="form-label"><i class="fas fa-key me-2"></i>API Key</label>
                <div class="api-key-input">
                    <input type="password" class="form-control" id="api_key" name="api_key" 
                           placeholder="Pega tu API Key de IsardVDI" required value="{{ saved_key or '' }}">
                    <i class="fas fa-eye toggle-password" id="togglePassword"></i>
                </div>
            </div>

            <div class="remember-box">
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="remember" name="remember" {{ 'checked' if saved_key else '' }}>
                    <label class="form-check-label" for="remember">
                        Recordar API Key en este dispositivo
                    </label>
                </div>
            </div>

            <button type="submit" class="btn btn-login">
                <i class="fas fa-sign-in-alt me-2"></i>Iniciar Sesi칩n
            </button>
        </form>

        <div class="info-box">
            <strong><i class="fas fa-info-circle me-2"></i>쮻칩nde encuentro mi API Key?</strong>
            <ol class="mb-0 mt-2">
                <li>Accede a <a href="https://cloud.uni.eus" target="_blank">cloud.uni.eus</a></li>
                <li>Ve a tu perfil de usuario</li>
                <li>Busca la secci칩n "API Keys"</li>
                <li>Copia tu API Key y p칠gala aqu칤</li>
            </ol>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Toggle password visibility
        document.getElementById('togglePassword').addEventListener('click', function() {
            const passwordInput = document.getElementById('api_key');
            const icon = this;
            
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
            } else {
                passwordInput.type = 'password';
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
            }
        });
    </script>
</body>
</html>
"""


@app.route("/login", methods=["GET", "POST"])
def login():
    if request.method == "POST":
        api_key = request.form.get("api_key", "").strip()
        remember = request.form.get("remember") == "on"
        
        if not api_key:
            flash("Por favor ingresa una API Key", "danger")
            return redirect(url_for("login"))
        
        # Test the API key
        test_url = f"{API_BASE_URL}/user/desktops"
        test_headers = {"Authorization": f"Bearer {api_key}", "Content-Type": "application/json"}
        
        try:
            response = requests.get(test_url, headers=test_headers, timeout=10)
            response.raise_for_status()
            
            # API key is valid, save it
            session['api_key'] = api_key
            
            # Save to config if remember is checked
            if remember:
                config = load_config()
                config['last_api_key'] = base64.b64encode(api_key.encode()).decode()
                save_config(config)
            else:
                # Clear saved key if not remembering
                config = load_config()
                if 'last_api_key' in config:
                    del config['last_api_key']
                    save_config(config)
            
            flash("Sesi칩n iniciada correctamente", "success")
            return redirect(url_for("index"))
            
        except requests.exceptions.HTTPError as e:
            if e.response.status_code == 401:
                flash("API Key inv치lida. Por favor verifica e intenta de nuevo.", "danger")
            else:
                flash(f"Error al validar la API Key: {e.response.status_code}", "danger")
        except Exception as e:
            flash(f"Error de conexi칩n: {str(e)}", "danger")
        
        return redirect(url_for("login"))
    
    # GET request - show login form
    config = load_config()
    saved_key = None
    if 'last_api_key' in config:
        try:
            saved_key = base64.b64decode(config['last_api_key']).decode()
        except Exception:
            pass
    
    return render_template_string(LOGIN_TEMPLATE, saved_key=saved_key)


@app.route("/logout")
def logout():
    session.pop('api_key', None)
    flash("Sesi칩n cerrada", "info")
    return redirect(url_for("login"))


@app.route("/")
@require_api_key
def index():
    if not fetch_vms():
        # Check if it was an API key error
        if session.pop('api_error', None) == 'invalid_key':
            flash("Tu API Key ha expirado o ya no es v치lida. Por favor, ingresa una nueva API Key.", "warning")
            return redirect(url_for('login'))
        flash("Error al conectar con la API o al obtener las m치quinas.", "danger")
        return render_template_string(HTML_TEMPLATE, maquinas={}, folders={}, unassigned_machines={})

    data_for_template = {}
    for vm_id, vm in MAQUINAS.items():
        vm["status_html"] = get_status_html(vm["status"])
        vm["folder_id"] = get_folder_for_machine(vm_id)
        data_for_template[vm_id] = vm

    # Prepare folder data with their machines
    folders_data = {}
    for folder_id, folder in FOLDERS.items():
        folders_data[folder_id] = {
            "name": folder["name"],
            "machines": get_machines_in_folder(folder_id)
        }
    
    # Machines without folder
    unassigned = get_machines_without_folder()

    return render_template_string(
        HTML_TEMPLATE, 
        maquinas=data_for_template, 
        folders=folders_data,
        unassigned_machines=unassigned
    )


@app.route("/start/<vm_id>")
@require_api_key
def start_vm(vm_id):
    success, message = api_action(vm_id, "start")
    if not success and session.pop('api_error', None) == 'invalid_key':
        flash("Tu API Key ha expirado o ya no es v치lida. Por favor, ingresa una nueva API Key.", "warning")
        return redirect(url_for('login'))
    flash(message, "success" if success else "danger")
    return redirect(url_for("index"))


@app.route("/stop/<vm_id>")
@require_api_key
def stop_vm(vm_id):
    success, message = api_action(vm_id, "stop")
    if not success and session.pop('api_error', None) == 'invalid_key':
        flash("Tu API Key ha expirado o ya no es v치lida. Por favor, ingresa una nueva API Key.", "warning")
        return redirect(url_for('login'))
    flash(message, "success" if success else "danger")
    return redirect(url_for("index"))


@app.route("/api/vms")
@require_api_key
def api_get_vms():
    """API endpoint para obtener datos de VMs en formato JSON (para refresh AJAX)."""
    if not fetch_vms():
        # Check if it was an API key error
        if session.pop('api_error', None) == 'invalid_key':
            return jsonify({"error": "API Key inv치lida o expirada", "redirect": url_for('login')}), 401
        return jsonify({"error": "Error al conectar con la API"}), 500
    
    # Preparar datos
    vms_data = {}
    for vm_id, vm in MAQUINAS.items():
        vms_data[vm_id] = {
            "id": vm["id"],
            "name": vm["name"],
            "status": vm["status"],
            "status_html": get_status_html(vm["status"]),
            "ips": vm["ips"],
            "folder_id": get_folder_for_machine(vm_id)
        }
    
    # Preparar carpetas
    folders_data = {}
    for folder_id, folder in FOLDERS.items():
        folder_machines = {}
        for vm_id in folder.get("machines", []):
            if vm_id in vms_data:
                folder_machines[vm_id] = vms_data[vm_id]
        folders_data[folder_id] = {
            "name": folder["name"],
            "machines": folder_machines
        }
    
    # Machines without folder
    assigned_machines = set()
    for folder in FOLDERS.values():
        assigned_machines.update(folder.get("machines", []))
    unassigned = {vm_id: vm for vm_id, vm in vms_data.items() if vm_id not in assigned_machines}
    
    return jsonify({
        "vms": vms_data,
        "folders": folders_data,
        "unassigned": unassigned
    })


@app.route("/api/viewers/<vm_id>")
@require_api_key
def api_get_viewers(vm_id):
    """API endpoint para verificar qu칠 viewers est치n disponibles para una VM."""
    viewers = {
        "vnc": False,
        "spice": False,
        "rdp": False
    }
    
    # Check browser-vnc
    headers = get_api_headers()
    if not headers:
        return jsonify(viewers)
    try:
        url = f"{API_BASE_URL}/desktop/{vm_id}/viewer/browser-vnc"
        response = requests.get(url, headers=headers, timeout=5)
        if response.status_code == 200:
            data = response.json()
            if data.get("urlp") or data.get("viewer"):
                viewers["vnc"] = True
    except Exception as e:
        print(f"Error checking VNC for {vm_id}: {e}")
    
    # Check file-spice
    try:
        url = f"{API_BASE_URL}/desktop/{vm_id}/viewer/file-spice"
        response = requests.get(url, headers=headers, timeout=5)
        if response.status_code == 200:
            data = response.json()
            if data.get("content") or data.get("kind") == "file" or data.get("values"):
                viewers["spice"] = True
    except Exception as e:
        print(f"Error checking SPICE for {vm_id}: {e}")
    
    # Check file-rdpgw
    try:
        url = f"{API_BASE_URL}/desktop/{vm_id}/viewer/file-rdpgw"
        response = requests.get(url, headers=headers, timeout=5)
        if response.status_code == 200:
            data = response.json()
            if data.get("content") or data.get("kind") == "file" or data.get("values"):
                viewers["rdp"] = True
    except Exception as e:
        print(f"Error checking RDP for {vm_id}: {e}")
    
    return jsonify(viewers)


@app.route("/debug/viewer/<vm_id>")
@app.route("/debug/viewer/<vm_id>/<viewer_type>")
def debug_viewer(vm_id, viewer_type="file-rdp"):
    """Debug endpoint para ver qu칠 devuelve la API del viewer."""
    url = f"{API_BASE_URL}/desktop/{vm_id}/viewer/{viewer_type}"
    headers = get_api_headers()
    if not headers:
        return jsonify({"error": "No API Key configured", "url_called": url})
    try:
        response = requests.get(url, headers=headers)
        return jsonify({
            "status_code": response.status_code,
            "headers": dict(response.headers),
            "content_type": response.headers.get("Content-Type"),
            "text_preview": response.text[:500] if response.text else None,
            "url_called": url
        })
    except Exception as e:
        return jsonify({"error": str(e), "url_called": url})


@app.route("/viewer/<vm_id>")
@app.route("/viewer/<vm_id>/<viewer_type>")
@require_api_key
def get_viewer(vm_id, viewer_type="browser-vnc"):
    """Obtiene la URL del visor y redirige o devuelve el archivo."""
    viewer_data = get_viewer_url(vm_id, viewer_type)
    
    if request.args.get("json"):
        if viewer_data:
            return jsonify({"data": viewer_data, "type": viewer_type})
        return jsonify({"error": "No se pudo obtener la URL del visor"}), 404
    
    if viewer_data:
        # Handle our structured response
        if isinstance(viewer_data, dict):
            if viewer_data.get("type") == "url":
                # For browser-vnc, we need to handle the cookie for WebSocket auth
                if viewer_type == "browser-vnc":
                    url = viewer_data["url"]
                    # Get the cookie from the API response (it's in the raw response)
                    # We'll fetch again to get the cookie
                    try:
                        api_url = f"{API_BASE_URL}/desktop/{vm_id}/viewer/{viewer_type}"
                        headers = get_api_headers()
                        if not headers:
                            return redirect(url)
                        response = requests.get(api_url, headers=headers)
                        data = response.json()
                        cookie_value = data.get("cookie", "")
                        
                        if cookie_value:
                            # Create an HTML page that sets the cookie and redirects
                            # The cookie must be set on cloud.uni.eus domain
                            html = f'''<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Conectando al visor VNC...</title>
    <style>
        body {{
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }}
        .container {{
            text-align: center;
            background: rgba(255,255,255,0.1);
            padding: 40px;
            border-radius: 15px;
        }}
        .spinner {{
            border: 4px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top: 4px solid white;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }}
        @keyframes spin {{
            0% {{ transform: rotate(0deg); }}
            100% {{ transform: rotate(360deg); }}
        }}
        a {{
            color: white;
            text-decoration: underline;
        }}
    </style>
</head>
<body>
    <div class="container">
        <h2>Conectando al escritorio VNC...</h2>
        <div class="spinner"></div>
        <p>Si no se abre autom치ticamente, <a href="{url}" id="manual-link">haz clic aqu칤</a></p>
    </div>
    <script>
        // Redirect immediately to the VNC viewer
        // The cookie is set by the IsardVDI API when we make the request
        window.location.href = "{url}";
    </script>
</body>
</html>'''
                            return Response(html, mimetype='text/html')
                    except Exception as e:
                        print(f"Error getting cookie: {e}")
                    
                    # Fallback: just redirect
                    return redirect(url)
                else:
                    return redirect(viewer_data["url"])
            elif viewer_data.get("type") == "rdp_file":
                filename = viewer_data.get("filename", f"desktop-{vm_id}.rdp")
                mime = viewer_data.get("mime", "application/x-rdp")
                return Response(
                    viewer_data["content"],
                    mimetype=mime,
                    headers={"Content-Disposition": f"attachment; filename={filename}"}
                )
            elif viewer_data.get("type") == "spice_file":
                filename = viewer_data.get("filename", f"desktop-{vm_id}.vv")
                mime = viewer_data.get("mime", "application/x-virt-viewer")
                return Response(
                    viewer_data["content"],
                    mimetype=mime,
                    headers={"Content-Disposition": f"attachment; filename={filename}"}
                )
        
        # Handle data URI (like RDP files)
        if isinstance(viewer_data, str) and viewer_data.startswith("data:"):
            try:
                header, encoded_content = viewer_data.split(",", 1)
                content = unquote(encoded_content)
                
                if "x-rdp" in header:
                    filename = f"desktop-{vm_id}.rdp"
                    mimetype = "application/x-rdp"
                elif "x-virt-viewer" in header:
                    filename = f"desktop-{vm_id}.vv"
                    mimetype = "application/x-virt-viewer"
                else:
                    filename = f"desktop-{vm_id}.txt"
                    mimetype = "text/plain"
                
                return Response(
                    content,
                    mimetype=mimetype,
                    headers={"Content-Disposition": f"attachment; filename={filename}"}
                )
            except Exception as e:
                print(f"Error parsing data URI: {e}")
                return redirect(viewer_data)
        
        # Handle regular URL string
        elif isinstance(viewer_data, str):
            return redirect(viewer_data)
    
    flash("No se pudo obtener la conexi칩n al escritorio. Aseg칰rate de que la m치quina est칠 encendida.", "danger")
    return redirect(url_for("index"))


# ==============================================================================
# FOLDER MANAGEMENT ROUTES
# ==============================================================================


@app.route("/folder/create", methods=["POST"])
@require_api_key
def create_folder():
    """Creates a new folder."""
    folder_name = request.form.get("folder_name", "").strip()
    if not folder_name:
        flash("El nombre de la carpeta no puede estar vac칤o.", "danger")
        return redirect(url_for("index"))
    
    folder_id = get_next_folder_id()
    FOLDERS[folder_id] = {"name": folder_name, "machines": []}
    save_folders()
    flash(f"Carpeta '{folder_name}' creada correctamente.", "success")
    return redirect(url_for("index"))


@app.route("/folder/rename/<folder_id>", methods=["POST"])
@require_api_key
def rename_folder(folder_id):
    """Renombra una carpeta existente."""
    if folder_id not in FOLDERS:
        flash("Carpeta no encontrada.", "danger")
        return redirect(url_for("index"))
    
    new_name = request.form.get("folder_name", "").strip()
    if not new_name:
        flash("El nombre de la carpeta no puede estar vac칤o.", "danger")
        return redirect(url_for("index"))
    
    FOLDERS[folder_id]["name"] = new_name
    save_folders()
    flash(f"Carpeta renombrada a '{new_name}'.", "success")
    return redirect(url_for("index"))


@app.route("/folder/delete/<folder_id>")
@require_api_key
def delete_folder(folder_id):
    """Elimina una carpeta (las m치quinas vuelven a 'Sin carpeta')."""
    if folder_id not in FOLDERS:
        flash("Carpeta no encontrada.", "danger")
        return redirect(url_for("index"))
    
    folder_name = FOLDERS[folder_id]["name"]
    del FOLDERS[folder_id]
    save_folders()
    flash(f"Carpeta '{folder_name}' eliminada.", "success")
    return redirect(url_for("index"))


@app.route("/folder/assign/<folder_id>/<vm_id>")
@require_api_key
def assign_to_folder(folder_id, vm_id):
    """Assigns a machine to a folder."""
    if folder_id not in FOLDERS:
        flash("Carpeta no encontrada.", "danger")
        return redirect(url_for("index"))
    
    # First, remove the machine from any previous folder
    for fid, folder in FOLDERS.items():
        if vm_id in folder.get("machines", []):
            folder["machines"].remove(vm_id)
    
    # Agregar a la nueva carpeta
    if vm_id not in FOLDERS[folder_id]["machines"]:
        FOLDERS[folder_id]["machines"].append(vm_id)
    
    save_folders()
    flash(f"M치quina asignada a '{FOLDERS[folder_id]['name']}'.", "success")
    return redirect(url_for("index"))


@app.route("/folder/unassign/<vm_id>")
@require_api_key
def unassign_from_folder(vm_id):
    """Quita una m치quina de su carpeta actual."""
    for folder in FOLDERS.values():
        if vm_id in folder.get("machines", []):
            folder["machines"].remove(vm_id)
            save_folders()
            flash("M치quina removida de la carpeta.", "success")
            return redirect(url_for("index"))
    
    flash("La m치quina no estaba en ninguna carpeta.", "info")
    return redirect(url_for("index"))


if __name__ == "__main__":
    print("Iniciando servicio...")
    app.run(debug=True, host="0.0.0.0", port=5000)
